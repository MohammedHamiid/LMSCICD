default_platform(:ios)

platform :ios do
  desc "Build and upload to TestApp.io"
  lane :beta do
    # Use fastlane match to fetch certificates and provisioning profiles
    match(type: "adhoc")  # This will pull certificates and provisioning profiles

    gym(
      scheme: "LMSCICD",   # Replace with your actual scheme name
      export_method: "ad-hoc",  # or "app-store" if you are using App Store distribution
      export_options: {
        signingStyle: "automatic"
      },
      xcargs: "-allowProvisioningUpdates"
    )

    ipa_path = Actions.lane_context[SharedValues::IPA_OUTPUT_PATH]

    # Upload to TestApp.io
    sh <<-EOF
      curl -X POST https://upload.testapp.io/api/apps/9QorGVmE7M/builds \
        -H "Authorization: Bearer #{ENV['TESTAPP_API_KEY']}" \
        -F "file=@#{ipa_path}" \
        -F "release_notes=Uploaded automatically via Fastlane ðŸŽ‰"
    EOF
  end
end
