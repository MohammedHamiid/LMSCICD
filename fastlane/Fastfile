default_platform(:ios)

platform :ios do
  desc "Build and upload to TestApp.io"
  lane :beta do
    # Ensure the required environment variables are set
    if ENV['FASTLANE_USER'].nil? || ENV['FASTLANE_APP_SPECIFIC_PASSWORD'].nil? || ENV['TESTAPP_API_KEY'].nil?
      UI.user_error!("Required environment variables are missing. Please check FASTLANE_USER, FASTLANE_APP_SPECIFIC_PASSWORD, and TESTAPP_API_KEY.")
    end

    # Use fastlane match to fetch certificates and provisioning profiles
    match(
      type: "adhoc", 
      username: ENV['FASTLANE_USER'],  # Ensure this is set correctly
      app_identifier: "com.benhamid.LMSCICD",  # Replace with your actual app identifier
      api_key: ENV['FASTLANE_APP_SPECIFIC_PASSWORD']  # This is your app-specific password
    )

    # Build the app using gym
    gym(
      scheme: "LMSCICD",  # Replace with your actual scheme
      export_method: "ad-hoc",  # Use 'app-store' if you're distributing via the App Store
      export_options: {
        signingStyle: "automatic",
        provisioningProfiles: {
          "com.benhamid.LMSCICD" => "match AdHoc com.benhamid.LMSCICD"
        }
      },
      xcargs: "-allowProvisioningUpdates"
    )

    # Get the path of the generated IPA
    ipa_path = Actions.lane_context[SharedValues::IPA_OUTPUT_PATH]

    # Upload to TestApp.io
    sh <<-EOF
      curl -X POST https://upload.testapp.io/api/apps/9QorGVmE7M/builds \
        -H "Authorization: Bearer #{ENV['TESTAPP_API_KEY']}" \
        -F "file=@#{ipa_path}" \
        -F "release_notes=Uploaded automatically via Fastlane ðŸŽ‰"
    EOF
  end
end
